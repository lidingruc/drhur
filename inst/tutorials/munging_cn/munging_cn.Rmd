---
title: "Dr. Hu's R Workshop"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---


```{r setup, include=FALSE}
library(learnr)
library(tidyverse)
library(gapminder)
```

# 课程 II: 数据整理

哈！大家好，我是萌萌！欢迎来到“Learning R with Dr. Hu and His Friends”!
恭喜你成功完成第一关——数据输入与输出，接下来就让我们开启`R expert`的第二站之旅吧。本次闯关需要具备数据归纳和提取的技能哟，请认真学习！

## 今天的大boss

由 [Hans Rosling 的 TED 演讲](https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen?utm_campaign=tedspread--b&utm_medium=referral&utm_source=tedcomshare) 普及的人口数据。

```{r toy, exercise = TRUE}
library(gapminder)
gapminder
```

## 数据归纳

### 初探数据
```{r glimpse, exercise = TRUE}
head(gapminder, n = 6) # 查看数据框中的前6行

str(gapminder)  #查看数据框当中有哪些变量以及变量的类型：
```

### 系统探索

嗨，我是一名专家~ 我想从系统的视角了解数据, 例如找到

* 观察数据大小
* 变量的名字及数量
* 或者整个数据帧的结构

```{r systemView, exercise = TRUE}
gapminder
```

```{r systemView-solution}
nrow(gapminder) # 获取数据的行数
ncol(gapminder) # 获取数据的列数
names(gapminder) # 获取变量名/列名
str(gapminder) # 获取变量名、变量名类型、行数、列数
```


### 了解变量

问: 给我讲讲数据集中的人口变量, 比如说, 我们有多少个国家的人口数据, 平均值是多少, 哪个国家的人口最多／最少, 还有其他内容! 对了,  `pop` 被保存成了什么形式呢？

```{r variable, exercise = TRUE}
head(gapminder$year, n = 10) #查看年份前10行
```

```{r variable-solution}
mean(gapminder$year, na.rm = TRUE) #求取年份的平均值，na.rm = TRUE表示忽略NA
median(gapminder$year) #求取年份的中间值
min(gapminder$year) #求取年份的最小值
max(gapminder$year) #求取年份的最大值
length(gapminder$year) #求取年份的长度（此处为行数）
summary(gapminder$year) #获取年份的上述所有信息
class(gapminder$gdpPercap) #查看年份结构：vector、matrix、array、dataframe、list
typeof(gapminder$gdpPercap) #查看年份元素类型
```

## `Tidyverse`包

> 萌萌：欢迎来到 `Tidyverse`世界，让我们通过下面这张图一起揭开`Tidyverse`的庐山真面目吧！

```{r out.width = "60%", echo = FALSE}
knitr::include_graphics("images/tidyverseHive.png")
```

> 萌萌：哈！看完上面这张图，是不是对`Tidyverse`包有了新的了解？恭喜你，我们的闯关之旅又近了一步！

+ 一个Hadley包
+ 实际上是一个不断增长的 [数据包](https://www.tidyverse.org/packages/)！

+ 安装:

```{r loadTidy, exercise = TRUE}
## install.packages("tidyverse")
library("tidyverse")
```

> 萌萌：接下来就让我们一起了解今天故事的主角——`dplyr`。

##  `dplyr`包

他们只做一件事，却做得很好。

```{r out.width = "60%", echo = FALSE}
knitr::include_graphics("images/simple.png")
```

### 可组合性：

```{r out.width = "60%", echo = FALSE}
knitr::include_graphics("images/composable.png")
```

> 萌萌：想写出更加简洁和酷炫的代码吗？那就使用`dplyr`包吧！偷偷告诉你关于`%>%`的快捷键方式哟，这是属于我俩之间的秘密，可别告诉别人，嘘🤫！

 `%>%`的快捷键:

* Ctrl + Shift + M (Win)
* Cmd + Shift + M (Mac)

## 数据概览

### 拓展提升

> 萌萌：还记得上一关卡获取的 `str()`技能吗？让我们一起回忆一下吧

```{r overview, exercise = TRUE}
str(gapminder)
glimpse(gapminder)
```

### 按序查看

> 萌萌：你能告诉我哪个国家的人口最多&哪个国家的人口最少吗？

```{r out.width = "60%", echo = FALSE}
knitr::include_graphics("images/arrange.png")
```

```{r out.width = "90%", echo = FALSE}
knitr::include_graphics("images/desc.png")
```

```{r ex_arrange, exercise = TRUE}
gapminder
```

```{r ex_arrange-solution}
gapminder %>%
  arrange(pop) # arrange函数用于排序，此处为按照人口规模从小到大进行排序

arrange(gapminder, desc(pop)) #此处为按照人口规模进行降序排列
```


> 萌萌：呀！你真棒！那你还能告诉我每个大洲分别有多少个观测值?&每个大洲的观测值数量一样吗&每个国家呢？

```{r ex_count, exercise = TRUE}
gapminder %>%
  count(continent)

# gapminder %>%
#   add_count(continent)
```

```{r ex_count-solution}
gapminder %>%
  count(continent, country)
```

> 萌萌：试着使用`count()`，看看能获取什么，嘻嘻😁 

### 总结数据

> 萌萌：我想知道人均国民生产总值和预期寿命的中位数分别是什么，你能试着告诉我吗?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/summarise.png")
```


```{r ex_summary, exercise = TRUE}
gapminder %>%
  summarise(mean_gdp = mean(gdpPercap), median_life = median(lifeExp))
```

### 组内总结

> 萌萌：不懂就问，请问*每个大洲的*人均国民生产总值和预期寿命的中位数分别是什么？

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/group_by.png")
```

```{r ex_summaryG, exercise = TRUE}
gapminder %>%
  group_by(continent) %>%
  summarise(mean_gdp = mean(gdpPercap), median_life = median(lifeExp))
```

>萌萌：恭喜你将本次闯关之旅的进度条推进至1/2🎉🎉，加油，终点有丰厚的奖励哟🏁！

## 数据提取

### filter函数

>萌萌：试着看看*2007*年哪个国家的人口数量最多吗?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/filter.png")
```

```{r ex_filter, exercise = TRUE, exercise.eval = TRUE}
gapminder %>%
  arrange(desc(pop))
```

```{r ex_filter-solution}
gapminder %>%
  filter(year == 2007) %>% #filter函数筛选出年份为2007年
  arrange(desc(pop)) #再根据人口规模进行降序排列
```

>萌萌：如果你已经知道了2007年人口最多的国家，那么2007年以前的十年哪个国家的人口数量最多呢? (提示: 把 `%in%` 当成一个条件😁)

### select函数

>萌萌：接下来的挑战将会更难哟！你能告诉我：

1. 仅国家，年份和人口
2. 除了大洲的一切
3. 以"co"开头的变量

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/select.png")
```

```{r ex_select, exercise = TRUE}
gapminder %>%
  select(country, year, pop) #选择国家、年份、人口规模
```

```{r ex_select-solution}
gapminder %>%
  select(-continent) #去掉大洲

gapminder %>%
  select(starts_with("co")) #匹配以“co”开头的名称
```

### filter与select之双重暴击

>萌萌：2007年人口最多的国家的预期寿命是多少---请同时提供国家名称, 人口数量, 以及预期寿命?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/comboAttack.gif")
```

```{r ex_combo, exercise = TRUE}
gapminder
```

```{r ex_combo-solution}
gapminder %>%
  filter(year == 2007) %>%
  arrange(desc(pop)) %>%
  select(country, pop, lifeExp)
```

### mutate函数

>萌萌:每个国家的国民生产总值是多少?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/mutate.png")
```

```{r ex_mutate, exercise = TRUE}
gapminder %>%
  mutate(gdp = pop * gdpPercap) %>% #可根据已有变量添加新的变量，将新添加的列到已有列的末尾
    select(country, pop, gdpPercap, gdp)
```

>萌萌:我想保留数值型变量中的整数，该怎么做了？

```{r ex_batch, exercise = TRUE}
gapminder %>%
  mutate_if(is.double, round, digits = 0) #mutate_if对数据进行判断，如果是T，则对其进行四舍五入操作
```

### 敲黑板！

当使用 `gapminder %>% ...`指令的时候, 你<span style="color:red">没有</span>增加或改变`gapminder`的任何东西.
如果你想把变化保存下来, 把结果发给一个对象。

```{r eval = FALSE}
gapminderNew <- gapminder %>% ...
```

## 课后思考

1. 行动<span style="color:red">之前</span> 弄清楚逻辑;
1. 巧妙地使用 `dplyr` 的功能并融会贯通;
    + 归纳: `arrange`, `count`, `summarise`
    + 提取: `filter`, `select`, `mutate`
1. 不要忘了 `group_by` 和 `mutate_if`

## 额外奖励

```{r df_coalesce, echo = FALSE}
df_toy <- data.frame(x = sample(c(1:2, NA, NA, NA)),
                     y = c(1, 2, NA, NA, 5),
                     z = c(NA, NA, 3, 4, 5))
```

>萌萌: 我怎么样才能填补缺失的 `x`, 然后把 `y` 和 `z` 合并成一个变量呢?

```{r coalesce, exercise = TRUE}
df_toy %>%
  mutate(x = coalesce(x, 0L),
         yz = coalesce(y, z))
```


## 谢谢！

<i class="fa fa-envelope fa-lg"></i>&nbsp; [yuehu@tsinghua.edu.cn](mailto:yuehu@tsinghua.edu.cn)

<i class="fa fa-globe fa-lg"></i>&nbsp; https://sammo3182.github.io/

<i class="fab fa-github fa-lg"></i>&nbsp; [sammo3182](https://github.com/sammo3182)
