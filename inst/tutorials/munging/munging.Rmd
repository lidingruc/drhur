---
title: "Dr. Hu's R Workshop"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---


```{r setup, include=FALSE}
library(learnr)
library(tidyverse)
library(gapminder)
```

# Lecture II: Data Munging

## Skills

1. Generalization: Arrange, count, summarise
1. Extraction: Filter, select, mutate

## Abilities You'll Achieve

1. Be the "family doctor" to your dataset
1. Reserve the valuable part easily! and quickly!

## Your "Patient" Today

Demographic statistics popularized by [Hans Rosling's TED talks](https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen?utm_campaign=tedspread--b&utm_medium=referral&utm_source=tedcomshare).

```{r toy, exercise = TRUE}
library(gapminder)
gapminder
```

## Generalization

### Knowing about the Data

```{r glimpse, exercise = TRUE}
head(gapminder, n = 6)

## Systemic view

str(gapminder)
```

### Knowing professionally

Hey, I'm a professional~ I wanna see the data in a systematic way, such as finding out 

* Size of the observations
* Number and names of the variables included
* Or the structure of the entire data frame

```{r systemView, exercise = TRUE}
gapminder
```

```{r systemView-solution}
nrow(gapminder)
ncol(gapminder)
names(gapminder)
str(gapminder)
```


### Knowing about the Variable

Q: Tell me something about the population variable in the dataset, like, how many countries' population we have, what the average, who has the largest and smallest population, and many other things! Btw, what type the `pop` is stored?

```{r variable, exercise = TRUE}
head(gapminder$year, n = 10)
```

```{r variable-solution}
mean(gapminder$year, na.rm = TRUE)
median(gapminder$year)
min(gapminder$year)
max(gapminder$year)
length(gapminder$year)
summary(gapminder$year)

class(gapminder$gdpPercap)
typeof(gapminder$gdpPercap)
```

## Fancier Moves 

Welcome to the Tidyverse

```{r out.width = "100%", echo = FALSE}
knitr::include_graphics("images/tidyverseHive.png")
```

Prevalent toolkit for data manipulation 

+ A Hadley package
+ A growing [set](https://www.tidyverse.org/packages/) of packages, actually! 

Installation:

```{r loadTidy, exercise = TRUE}
## install.packages("tidyverse")
library("tidyverse")
```

We focus on `dplyr` today.

## Five Guns of `dplyr`

They do one thing, but they do it well.

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/simple.png")
```

### Composability: Make Everything Different

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/composable.png")
```

Making codes more readable.

Shortcut for `%>%`: 

* Ctrl + Shift + M (Win)
* Cmd + Shift + M (Mac)

## Data Overview

### Beyond the base 

You still remember `str()`, right?

```{r overview, exercise = TRUE}
str(gapminder)
glimpse(gapminder)
```

### View in Order

Q: Which countries have the largest populations? And the smallest?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/arrange.png")
```

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/desc.png")
```

```{r ex_arrange, exercise = TRUE}
gapminder
```

```{r ex_arrange-solution}
gapminder %>% 
  arrange(pop)

arrange(gapminder, desc(pop))
```

### "Give me some numbers"!

Q: How many observations do we have in each continent? Do we have same number of observations in each countries in the same continent?

```{r ex_count, exercise = TRUE}
gapminder %>% 
  count(continent)

# gapminder %>% 
#   add_count(continent)
```

```{r ex_count-solution}
gapminder %>% 
  count(continent, country)
```

What does `count()` give?

### Stats to variables

Q: What was the average GDP per capita and median life expectancy?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/summarise.png")
```


```{r ex_summary, exercise = TRUE}
gapminder %>% 
  summarise(mean_gdp = mean(gdpPercap), median_life = median(lifeExp))
```

### Summarise in groups

Q: What was the average GDP per capita and median life expectancy *in each continent*?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/group_by.png")
```


```{r ex_summaryG, exercise = TRUE}
gapminder %>% 
  group_by(continent) %>% 
  summarise(mean_gdp = mean(gdpPercap), median_life = median(lifeExp))
```


## Extraction

### Rows

Q: Which countries had the largest population in *2007*?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/filter.png")
```


```{r ex_filter, exercise = TRUE, exercise.eval = TRUE}
gapminder %>% 
  arrange(desc(pop))
```

```{r ex_filter-solution}
gapminder %>% 
  filter(year == 2007) %>% 
  arrange(desc(pop))
```

How about which country had the largest population in the decade ending with 2007? (Tip: using `%in%` as a condition)

### Columns

Q: If I want

1. Only country, year, and population
2. Everything but not continent
3. Variables starting with "co"

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/select.png")
```

```{r ex_select, exercise = TRUE}
gapminder %>% 
  select(country, year, pop)
```

```{r ex_select-solution}
gapminder %>% 
  select(-continent)

gapminder %>% 
  select(starts_with("co"))
```

### Combo Attack

Q: What's the life expectancy of the country that had the largest population in 2007---showing the country name, population, and life expectancy together, please?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/comboAttack.gif")
```

```{r ex_combo, exercise = TRUE}
gapminder
```

```{r ex_combo-solution}
gapminder %>% 
  filter(year == 2007) %>% 
  arrange(desc(pop)) %>% 
  select(country, pop, lifeExp)
```

### Modification

Q: What's the total GDP of each country?

```{r out.width = "95%", echo = FALSE}
knitr::include_graphics("images/mutate.png")
```

```{r ex_mutate, exercise = TRUE}
gapminder %>% 
  mutate(gdp = pop * gdpPercap) %>% 
    select(country, pop, gdpPercap, gdp)
```

### Batch Modification

Q: How do we only keep the integers for all the numeric variables?

```{r ex_batch, exercise = TRUE}
gapminder %>% 
  mutate_if(is.double, round, digits = 0)
```

### Important note

When doing `gapminder %>% ...`, you are <span style="color:red">NOT</span> adding or changing anything of the `gapminder`.
If you want to save the changes, send the result to an object.

```{r eval = FALSE}
gapminderNew <- gapminder %>% ...
```

## Take-Home Points

1. Be clear about the logic <span style="color:red">before</span>  the moves;
1. Use the `dplyr` functions wisely and in combo;
    + Generalization: `arrange`, `count`, `summarise`
    + Extraction: `filter`, `select`, `mutate`
1. Don't forget `group_by` and `mutate_if`

## Bonus: Combining variables

```{r df_coalesce, echo = FALSE}
df_toy <- data.frame(x = sample(c(1:2, NA, NA, NA)),
                     y = c(1, 2, NA, NA, 5),
                     z = c(NA, NA, 3, 4, 5))
```

Q: I want to fill the missing in the `x`, and combine `y` and `z` to one variable? 

```{r coalesce, exercise = TRUE}
df_toy %>% 
  mutate(x = coalesce(x, 0L),
         yz = coalesce(y, z))
```


## Thank you!

<i class="fa fa-envelope fa-lg"></i>&nbsp; [yuehu@tsinghua.edu.cn](mailto:yuehu@tsinghua.edu.cn)

<i class="fa fa-globe fa-lg"></i>&nbsp; https://sammo3182.github.io/

<i class="fab fa-github fa-lg"></i>&nbsp; [sammo3182](https://github.com/sammo3182)
